// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "commonjs"
}

datasource db {
  provider = "postgresql"
  // provider = "sqlite" // for local dev test
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  username  String
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user")
}

model Lesson {
  id           String       @id @default(uuid())
  lessonNumber Int          @unique @map("lesson_number") // Thêm @unique vì số bài không trùng
  vocabularies Vocabulary[] @relation("LessonVocabularies") // 1 - n bảng Vocabulary
  grammars     Grammar[]    @relation("LessonGrammars") // 1 - n bảng Grammar
  kanjis       Kanji[]      @relation("LessonKanjis") // 1 - n bảng Kanji
  source       String? // minna no nihongo? || soumatome?
  level        Level
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@index([level]) // Index cho query theo level
  @@index([source]) // Index cho query theo source
  @@map("lesson")
}

model Vocabulary {
  id        String            @id @default(uuid())
  word      String
  kana      String?
  romaji    String?
  meaning   String
  wordType  WordType          @map("word_type")
  level     Level
  examples  Example[]
  media     Media[]
  lesson    Lesson?           @relation("LessonVocabularies", fields: [lessonId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  kanjis    VocabularyKanji[] // Many-to-Many qua bảng trung gian
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  lessonId String?

  @@index([lessonId])
  @@map("vocabulary")
}

model Grammar {
  id          String    @id @default(uuid())
  pattern     String
  structure   String
  meaning     String
  explanation String? // Sửa typo
  notes       String?
  examples    Example[]
  level       Level
  lesson      Lesson?   @relation("LessonGrammars", fields: [lessonId], references: [id], onDelete: SetNull, onUpdate: Cascade) // Thêm relation name
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  lessonId String?

  @@index([lessonId])
  @@map("grammar")
}

model Kanji {
  id           String            @id @default(uuid())
  character    String            @unique
  kana         String
  onyomi       String?
  kunyomi      String?
  meaning      String
  level        Level
  strokeCount  Int?              @map("stroke_count")
  examples     Example[]
  vocabularies VocabularyKanji[] // Many-to-Many qua bảng trung gian
  lesson       Lesson?           @relation("LessonKanjis", fields: [lessonId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  lessonId String?

  @@index([lessonId])
  @@map("kanji")
}

model VocabularyKanji {
  id         String     @id @default(uuid())
  vocabulary Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)
  kanji      Kanji      @relation(fields: [kanjiId], references: [id], onDelete: Cascade)
  position   Int? // Vị trí của kanji trong từ (tuỳ chọn)

  vocabularyId String
  kanjiId      String

  @@unique([vocabularyId, kanjiId]) // Không cho trùng lặp
  @@index([vocabularyId])
  @@index([kanjiId])
  @@map("vocabulary_kanji")
}

model Listening {
  id    String @id @default(uuid())
  level Level

  @@map("listening")
}

model Reading {
  id    String @id @default(uuid())
  level Level

  @@map("reading")
}

model Media {
  id        String   @id @default(uuid())
  audio     String?
  image     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  vocabulary   Vocabulary? @relation(fields: [vocabularyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  vocabularyId String?

  @@map("media")
}

model Example {
  id          String @id @default(uuid())
  title       String
  description String

  vocabulary   Vocabulary? @relation(fields: [vocabularyId], references: [id])
  vocabularyId String?
  grammar      Grammar?    @relation(fields: [grammarId], references: [id])
  grammarId    String?
  kanji        Kanji?      @relation(fields: [kanjiId], references: [id])
  kanjiId      String?

  @@map("example")
}

// JLPT Level
enum Level {
  N5
  N4
  N3
  N2
  N1
}

enum WordType {
  NOUN
  VERB
  I_ADJECTIVE
  NA_ADJECTIVE
  ADVERB
  PARTICLE
  CONJUNCTION
  PRONOUN
  EXPRESSION
  COUNTER
  OTHER
}
